<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hitchhiker's Guide to the Galaxy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Audiowide&display=swap');

        :root {
            --guide-bg: #1a1a1a;
            --guide-case: #C2185B; /* The reddish-pink plastic */
            --screen-bg: #000000;
            --screen-glow: #28f528; /* Classic vector green */
            --screen-amber: #ffb000;
            --bezel: #333;
            --key-dark: #222;
            --key-light: #444;
            --key-accent: #d32f2f;
        }

        body {
            background-color: #121212;
            color: var(--screen-glow);
            font-family: 'Share Tech Mono', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }

        /* The Device Case */
        .guide-casing {
            width: 95vw;
            max-width: 900px;
            height: 90vh;
            max-height: 800px;
            background: #2a2a2a;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 
                0 0 0 5px #111,
                0 20px 50px rgba(0,0,0,0.8),
                inset 0 0 20px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 2px solid #444;
        }

        /* The Screen Area */
        .screen-bezel {
            background: #000;
            border-radius: 10px;
            flex-grow: 1; /* Takes available space */
            min-height: 30%; /* Reduced slightly to allow keyboard growth */
            padding: 15px;
            border: 4px solid #333;
            box-shadow: inset 0 0 10px rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 10;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.7);
        }

        .screen-content {
            /* FLEX FIX: ensures content takes remaining space but doesn't overflow parent */
            flex: 1;
            min-height: 0; 
            overflow-y: auto;
            position: relative;
            z-index: 1;
            margin-top: 10px;
            padding-right: 5px; /* Space for scrollbar */
        }

        /* RETRO SCROLLBAR STYLING */
        .screen-content::-webkit-scrollbar {
            width: 8px;
            display: block;
        }
        .screen-content::-webkit-scrollbar-track {
            background: #111; 
            border: 1px solid #333;
        }
        .screen-content::-webkit-scrollbar-thumb {
            background: var(--screen-glow); 
            border-radius: 0;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
        }
        .screen-content::-webkit-scrollbar-thumb:hover {
            background: #3aff3a;
        }

        /* Graphics & Text */
        .dont-panic {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Audiowide', cursive;
            font-size: clamp(2rem, 5vw, 4rem);
            color: var(--screen-amber);
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--screen-amber);
            z-index: 5;
            text-align: center;
            opacity: 0;
            transition: opacity 1s;
        }

        .show-panic { opacity: 1; }

        #guide-text {
            font-size: 1.2rem;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.3;
        }

        /* Keyboard Area */
        .keyboard-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: inset 0 0 10px #000;
            flex-shrink: 0; /* Prevent keyboard from squashing */
        }

        .input-display {
            background: #0a0a0a;
            border: 2px solid #444;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 1.2rem;
            color: var(--screen-glow);
            font-family: 'Share Tech Mono';
            display: flex;
            align-items: center;
            overflow: hidden;
            text-transform: uppercase;
            height: 30px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        /* Essential for preserving spaces in textContent */
        #user-input {
            white-space: pre;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 18px;
            background: var(--screen-glow);
            animation: blink 1s step-end infinite;
            margin-left: 2px;
        }

        /* On-Screen Keyboard Grid */
        .onscreen-keyboard {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .key-row {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .key {
            background: linear-gradient(to bottom, #3a3a3a, #222);
            border: 1px solid #111;
            border-top: 1px solid #555;
            border-radius: 4px;
            color: #ccc;
            font-family: 'Share Tech Mono';
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 3px 0 #000, 0 4px 5px rgba(0,0,0,0.5);
            transition: all 0.05s;
            width: 40px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        .key:active, .key.active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #000, inset 0 2px 5px rgba(0,0,0,0.8);
            background: #111;
            color: var(--screen-glow);
        }

        .key.wide { width: 60px; }
        .key.space { width: 200px; }
        
        .key.action {
            background: linear-gradient(to bottom, #d32f2f, #b71c1c);
            color: white;
            border-top: 1px solid #ef5350;
        }
        .key.action:active, .key.action.active {
            background: #b71c1c;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .key.function {
            background: linear-gradient(to bottom, #1976D2, #0D47A1);
            color: white;
            border-top: 1px solid #42A5F5;
            font-size: 0.7rem;
        }

        /* AI Button Specific Styles */
        .key.ai-toggle {
            transition: all 0.3s ease;
        }
        .key.ai-toggle.online {
            background: linear-gradient(to bottom, #2e7d32, #1b5e20); /* Greenish */
            color: white;
            border-top: 1px solid #66bb6a;
            box-shadow: 0 3px 0 #000, 0 0 10px #2e7d32;
        }
        .key.ai-toggle.bypassed {
            background: linear-gradient(to bottom, #444, #222); /* Grey */
            color: #888;
            border-top: 1px solid #555;
        }

        /* Responsive tweaks for smaller screens (Phones) */
        @media (max-width: 600px) {
            .key { width: 8vw; height: 8vw; font-size: 0.8rem; }
            .key.space { width: 40vw; }
            .key.wide { width: 12vw; }
        }

        /* Responsive tweaks for Tablets/Portrait Mode (iPad) */
        @media (min-width: 601px) and (max-width: 1024px) and (orientation: portrait) {
            .guide-casing {
                height: 98vh; /* Maximize vertical usage */
                max-height: none;
                width: 95vw;
                padding: 10px;
                /* Removed padding-top since top buttons are gone */
            }
            
            .screen-bezel {
                /* Let screen shrink a bit to give room for big keys */
                flex-grow: 1; 
                min-height: 25%;
            }

            .keyboard-area {
                padding: 10px;
                gap: 8px;
            }

            /* Significantly larger keys for touch targets */
            .key { 
                width: 8vw; 
                height: 6.5vh; 
                font-size: 1.4rem; 
                border-radius: 6px;
            }
            .key.space { width: 40vw; }
            .key.wide { width: 14vw; }
            
            /* Bigger text for readability on iPad */
            #guide-text {
                font-size: 1.6rem;
                line-height: 1.5;
            }
            
            .input-display {
                font-size: 1.6rem;
                height: 45px; /* Increase height to fit larger text */
            }
            
            .cursor {
                height: 24px;
            }
            
            /* Hide status/mode toggle text on small widths if needed, or adjust pos */
            .mode-toggle { top: 5px; right: 5px; font-size: 0.6rem; }
        }


        .mode-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            color: #555;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 20;
        }

        /* --- NEW STATUS INDICATOR STYLES --- */
        /* Moved inside .screen-bezel */
        .status-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 20;
            cursor: pointer; /* Clickable */
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        .status-label {
            font-size: 0.6rem;
            color: #888;
            letter-spacing: 1px;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
        }

        .status-led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #440000; /* Dark red / Off */
            box-shadow: inset 0 1px 1px rgba(0,0,0,0.8);
            transition: all 0.3s;
        }

        .status-led.connected {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00, 0 0 8px #00ff00;
        }

        .status-led.disconnected {
            background: #ff0000;
            box-shadow: 0 0 5px #ff0000;
        }
        
        /* NEW SEARCH STATUS TEXT (Visible during loading) */
        .search-status {
            position: absolute;
            top: 75%;
            left: 0;
            width: 100%;
            text-align: center;
            font-family: 'Share Tech Mono', monospace;
            color: var(--screen-glow);
            font-size: 1.2rem;
            text-transform: uppercase;
            z-index: 10;
            display: none;
            text-shadow: 0 0 5px var(--screen-glow);
            animation: blink-text 0.5s infinite alternate;
        }
        
        @keyframes blink-text {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        /* ---------------------------------- */

        .wireframe-planet {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 1px solid var(--screen-glow);
            display: none;
            animation: spin 10s linear infinite;
            box-shadow: 0 0 20px var(--screen-glow), inset 0 0 20px var(--screen-glow);
        }

        .wireframe-planet::before, .wireframe-planet::after {
            content: '';
            position: absolute;
            border: 1px solid var(--screen-glow);
            border-radius: 50%;
        }

        .wireframe-planet::before {
            top: 10%; bottom: 10%; left: 0; right: 0;
            transform: rotateX(60deg);
        }
        .wireframe-planet::after {
            top: 0; bottom: 0; left: 10%; right: 10%;
            transform: rotateY(60deg);
        }

        @keyframes blink { 50% { opacity: 0; } }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* Header Bar */
        .header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--screen-glow);
            margin-bottom: 5px;
            padding-bottom: 5px;
            flex-shrink: 0; /* Prevent header shrinking */
        }
        
        .header-title {
            background: var(--screen-glow);
            color: black;
            padding: 0 5px;
            font-weight: bold;
        }

        /* Scanline flicker animation */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.95; }
            10% { opacity: 0.9; }
            15% { opacity: 0.95; }
            20% { opacity: 0.99; }
            50% { opacity: 0.95; }
            100% { opacity: 0.98; }
        }
        .screen-bezel {
            animation: flicker 0.15s infinite;
        }

    </style>
</head>
<body>

    <div class="guide-casing">
        
        <!-- NEW STATUS INDICATOR -->
        <div class="status-panel" title="Local AI Connection Status (Click for Diagnostic)">
            <div id="status-led" class="status-led disconnected"></div>
            <span class="status-label">SUB-ETHA LINK</span>
        </div>

        <!-- Default text is AI: BYPASSED -->
        <button class="mode-toggle" id="configBtn" title="Config AI">AI: BYPASSED</button>

        <div class="screen-bezel">
            <div class="crt-overlay"></div>
            
            <div id="boot-screen" class="dont-panic show-panic">DON'T PANIC</div>
            
            <div id="search-graphic" class="wireframe-planet"></div>
            
            <!-- NEW VISIBLE STATUS DISPLAY -->
            <div id="search-status" class="search-status"></div>

            <div class="screen-content" id="main-display" style="display: none;">
                <div class="header">
                    <span class="header-title">GUIDE</span>
                    <span id="entry-title">WAITING FOR INPUT</span>
                </div>
                <div id="guide-text"></div>
            </div>
            
            <!-- Background Matrix/Grid Canvas -->
            <canvas id="bg-canvas"></canvas>
        </div>

        <!-- NEW KEYBOARD LAYOUT -->
        <div class="keyboard-area">
            <div class="input-display">
                <span id="user-input"></span><span class="cursor"></span>
            </div>
            
            <div class="onscreen-keyboard" id="keyboard">
                <!-- Rows generated by JS for cleaner code or hardcoded below -->
                <div class="key-row">
                    <button class="key" data-key="1">1</button>
                    <button class="key" data-key="2">2</button>
                    <button class="key" data-key="3">3</button>
                    <button class="key" data-key="4">4</button>
                    <button class="key" data-key="5">5</button>
                    <button class="key" data-key="6">6</button>
                    <button class="key" data-key="7">7</button>
                    <button class="key" data-key="8">8</button>
                    <button class="key" data-key="9">9</button>
                    <button class="key" data-key="0">0</button>
                </div>
                <div class="key-row">
                    <button class="key" data-key="Q">Q</button>
                    <button class="key" data-key="W">W</button>
                    <button class="key" data-key="E">E</button>
                    <button class="key" data-key="R">R</button>
                    <button class="key" data-key="T">T</button>
                    <button class="key" data-key="Y">Y</button>
                    <button class="key" data-key="U">U</button>
                    <button class="key" data-key="I">I</button>
                    <button class="key" data-key="O">O</button>
                    <button class="key" data-key="P">P</button>
                </div>
                <div class="key-row">
                    <button class="key" data-key="A">A</button>
                    <button class="key" data-key="S">S</button>
                    <button class="key" data-key="D">D</button>
                    <button class="key" data-key="F">F</button>
                    <button class="key" data-key="G">G</button>
                    <button class="key" data-key="H">H</button>
                    <button class="key" data-key="J">J</button>
                    <button class="key" data-key="K">K</button>
                    <button class="key" data-key="L">L</button>
                </div>
                <div class="key-row">
                    <button class="key" data-key="Z">Z</button>
                    <button class="key" data-key="X">X</button>
                    <button class="key" data-key="C">C</button>
                    <button class="key" data-key="V">V</button>
                    <button class="key" data-key="B">B</button>
                    <button class="key" data-key="N">N</button>
                    <button class="key" data-key="M">M</button>
                    <!-- NEW AI TOGGLE BUTTON - Default is BYPASSED -->
                    <button class="key function ai-toggle bypassed" id="aiToggleBtn" title="Toggle AI Mode">AI</button>
                    <button class="key function" id="clearBtn" title="Clear">CLR</button>
                    <button class="key function" id="backspaceBtn" title="Backspace">DEL</button>
                </div>
                <div class="key-row">
                    <button class="key space" data-key="SPACE">SPACE</button>
                    <button class="key action wide" id="searchBtn">EXECUTE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        // hybridMode: false = AI OFF by default
        // ollamaModel: 'gemma3:270m' is a great small model.
        
        // DYNAMIC HOST DETECTION:
        // Use the hostname of the server serving this file, or 'localhost' if running locally/file protocol
        const ollamaHost = window.location.hostname || 'localhost';
        const ollamaBase = `http://${ollamaHost}:11434`;

        let config = {
            hybridMode: false,  // DEFAULT: OFF
            ollamaBase: ollamaBase,
            ollamaUrl: `${ollamaBase}/api/generate`,
            ollamaModel: 'gemma3:270m' 
        };

        /* --- DOM ELEMENTS --- */
        const userInput = document.getElementById('user-input');
        const guideText = document.getElementById('guide-text');
        const entryTitle = document.getElementById('entry-title');
        const bootScreen = document.getElementById('boot-screen');
        const mainDisplay = document.getElementById('main-display');
        const searchGraphic = document.getElementById('search-graphic');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const backspaceBtn = document.getElementById('backspaceBtn');
        const aiToggleBtn = document.getElementById('aiToggleBtn');
        const configBtn = document.getElementById('configBtn');
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        const keyboard = document.getElementById('keyboard');
        const statusLed = document.getElementById('status-led');
        const statusPanel = document.querySelector('.status-panel');
        const searchStatus = document.getElementById('search-status'); // NEW ELEMENT

        /* --- AUDIO SYNTHESIS (The Guide's Voice/Sound) --- */
        // Using SAFE initialization to prevent crash on old browsers
        let audioCtx;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.error("Web Audio API not supported", e);
        }
        
        /* --- iOS AUDIO UNLOCKER --- */
        // SAFE UNLOCK: Wrapped in try/catch to prevent blocking the UI if audio fails
        function unlockAudio() {
            if (!audioCtx) return;
            
            try {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
            } catch (e) {
                console.warn("Audio unlock failed (safe fail)", e);
            } finally {
                document.removeEventListener('click', unlockAudio, true);
                document.removeEventListener('touchstart', unlockAudio, true);
                document.removeEventListener('keydown', unlockAudio, true);
            }
        }

        // Listen for ANY initial interaction
        document.addEventListener('click', unlockAudio, true);
        document.addEventListener('touchstart', unlockAudio, true);
        document.addEventListener('keydown', unlockAudio, true);

        
        function playBeep(freq = 800, type = 'square', duration = 0.05) {
            if (!audioCtx) return;
            
            try {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            } catch(e) {
                // Ignore audio errors so text keeps working
            }
        }

        function playTypingSound() {
            // Randomize pitch slightly for organic computer feel
            playBeep(600 + Math.random() * 400, 'sawtooth', 0.03);
        }

        function playKeyClick() {
            playBeep(300, 'square', 0.03);
        }

        /* --- VISUALS --- */
        // Resize canvas
        function resizeCanvas() {
            canvas.width = mainDisplay.offsetWidth;
            canvas.height = mainDisplay.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Draw retro grid
        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(40, 245, 40, 0.1)';
            ctx.lineWidth = 1;
            
            const gridSize = 30;
            // Moving grid effect
            const offset = (Date.now() / 50) % gridSize;

            for(let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for(let y = offset; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            requestAnimationFrame(drawGrid);
        }
        drawGrid();

        /* --- CONNECTION CHECKER & DIAGNOSTIC --- */
        async function checkOllamaStatus() {
            try {
                // Try to hit the tags endpoint (standard Ollama endpoint)
                // If this fails, it's either down or CORS is blocked
                const response = await fetch(`${config.ollamaBase}/api/tags`, { 
                    method: 'GET'
                });
                
                if (response.ok) {
                    statusLed.className = 'status-led connected';
                    statusLed.parentElement.title = "Sub-Etha Link Established (Ollama Running) - Click for Info";
                } else {
                    throw new Error('Response not ok');
                }
            } catch (e) {
                statusLed.className = 'status-led disconnected';
                statusLed.parentElement.title = "Sub-Etha Link Offline (Check Ollama / CORS) - Click for Info";
            }
        }
        
        // Check immediately and then every 5 seconds
        checkOllamaStatus();
        setInterval(checkOllamaStatus, 5000);

        // Click handler for DIAGNOSTIC MODE
        statusPanel.addEventListener('click', async () => {
            // UI Feedback
            playKeyClick();
            mainDisplay.style.display = 'block';
            searchGraphic.style.display = 'none';
            searchStatus.style.display = 'none';
            bootScreen.style.opacity = '0';
            entryTitle.innerText = "SYSTEM DIAGNOSTIC";
            guideText.textContent = `INITIATING SUB-ETHA LINK DIAGNOSTIC...\nTarget: ${config.ollamaBase}\nModel: ${config.ollamaModel}\n\n`;

            try {
                // Test 1: Reachability
                guideText.textContent += "> Pinging server... ";
                const response = await fetch(`${config.ollamaBase}/api/tags`);
                
                if (response.ok) {
                     guideText.textContent += "OK\n";
                     const data = await response.json();
                     const models = data.models || [];
                     const modelNames = models.map(m => m.name);
                     
                     guideText.textContent += `> Found ${models.length} models.\n`;
                     
                     // Test 2: Model Existence
                     const hasModel = modelNames.some(n => n.includes(config.ollamaModel) || config.ollamaModel.includes(n));
                     
                     if (hasModel) {
                         guideText.textContent += `> Model '${config.ollamaModel}' CONFIRMED.\n\nSYSTEM READY.`;
                     } else {
                         guideText.textContent += `> WARNING: Model '${config.ollamaModel}' NOT FOUND.\n  Available: ${modelNames.join(', ')}\n\n  Please run: ollama pull ${config.ollamaModel}`;
                     }

                } else {
                    guideText.textContent += "FAILED (Server Error)\n";
                }
            } catch (e) {
                guideText.textContent += "FAILED\n\nERROR: " + e.message + "\n\nTROUBLESHOOTING:\n1. Is Ollama running?\n2. Did you set OLLAMA_ORIGINS=\"*\"?\n3. Are you using a modern browser preventing local connections?";
            }
        });


        /* --- TEXT ENGINE --- */
        let typingInterval;
        let isTyping = false;

        function typeText(text) {
            clearInterval(typingInterval);
            guideText.innerHTML = '';
            isTyping = true;
            let i = 0;
            
            // Speed up long texts
            // SLOWED DOWN BY HALF (20 -> 60 for short, 60 for long)
            let speed = text.length > 500 ? 20 : 60; 

            typingInterval = setInterval(() => {
                if (i < text.length) {
                    guideText.textContent += text.charAt(i);
                    if (i % 3 === 0) playTypingSound(); // Sound every 3 chars
                    
                    // Auto scroll
                    const contentDiv = document.querySelector('.screen-content');
                    contentDiv.scrollTop = contentDiv.scrollHeight;
                    
                    i++;
                } else {
                    clearInterval(typingInterval);
                    isTyping = false;
                }
            }, speed);
        }

        /* --- DATA FETCHING --- */

        async function fetchWikipedia(query) {
            // Check if running on file protocol
            if (window.location.protocol === 'file:') {
                return "PROTOCOL ERROR: The Guide cannot connect to the Sub-Etha Net (Wikipedia) from a local file path due to browser security restrictions.\n\nPlease run this file using a local web server (e.g., 'python -m http.server') or VS Code Live Server.";
            }

            // Helper function to fetch a page by specific title
            const getPage = async (title) => {
                const endpoint = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&redirects=1&origin=*&titles=${encodeURIComponent(title)}`;
                const response = await fetch(endpoint);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if (pageId === "-1") return null;
                return pages[pageId].extract;
            };

            try {
                // STRATEGY 1: Exact Title Match (Fast)
                // This covers queries like "Earth" or "The Beatles"
                let content = await getPage(query);
                if (content) return content;

                // STRATEGY 2: Fuzzy Search / Deep Search (Robust)
                // If "BEATLES" fails, this searches for "BEATLES" and finds "The Beatles"
                const searchStatus = document.getElementById('search-status');
                if(searchStatus) searchStatus.innerText = "DEEP SEARCHING...";
                
                const searchEndpoint = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
                const searchResp = await fetch(searchEndpoint);
                const searchData = await searchResp.json();
                
                if (searchData.query.search && searchData.query.search.length > 0) {
                    const bestMatchTitle = searchData.query.search[0].title;
                    content = await getPage(bestMatchTitle);
                    return content;
                }
                
                return null; // Truly nothing found
            } catch (e) {
                console.error(e);
                return "COMMUNICATION ERROR: Unable to contact Wikipedia.";
            }
        }

        async function summarizeWithOllama(wikiText, query) {
            // Updated prompt to take the Wiki text and reduce it
            // We truncate wikiText to first 1000 chars to save tokens/time
            const truncatedWiki = wikiText.substring(0, 2000); 
            
            const prompt = `You are "The Hitchhiker's Guide to the Galaxy". 
            
            SOURCE MATERIAL (Use ONLY this text):
            "${truncatedWiki}..."
            
            TASK: Rewrite the source material above into a Guide entry for "${query}".
            
            CRITICAL CONSTRAINTS:
            1. OUTPUT ONLY THE ENTRY. Do not say "Here is the entry" or "Sure". Start directly with the text.
            2. Limit to approx 80 words. MUST end in a complete sentence.
            3. Output must be a single block of text. No blank lines.
            4. Style: Humorous, cynical, dry, and slightly absurd (Douglas Adams style).
            5. ACCURACY: Do not invent facts. Summarize the provided text only.`;
            
            try {
                const response = await fetch(config.ollamaUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: config.ollamaModel,
                        prompt: prompt,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Post-processing to remove blank lines/excess whitespace
                let cleanText = data.response;
                // Replace multiple newlines with single newline
                cleanText = cleanText.replace(/\n\s*\n/g, '\n');
                // Trim whitespace
                cleanText = cleanText.trim();
                
                // Hard limit to prevent "screens of text"
                // Smart truncate: cut at the last punctuation mark before the limit
                if (cleanText.length > 700) {
                    const cutOff = cleanText.substring(0, 700);
                    const lastPunctuation = Math.max(
                        cutOff.lastIndexOf('.'),
                        cutOff.lastIndexOf('!'),
                        cutOff.lastIndexOf('?')
                    );
                    
                    if (lastPunctuation !== -1) {
                        cleanText = cutOff.substring(0, lastPunctuation + 1);
                    } else {
                        // Fallback if no punctuation found (rare for 700 chars)
                        cleanText = cutOff + "...";
                    }
                }
                
                return { success: true, text: cleanText };
            } catch (e) {
                console.error("Ollama Error:", e);
                // Return detailed error for debugging
                return { success: false, error: e.message };
            }
        }

        async function performSearch() {
            const query = userInput.textContent.trim();
            if (!query) return;

            // UI State 1: Searching Wikipedia
            bootScreen.style.opacity = '0';
            mainDisplay.style.display = 'none';
            searchGraphic.style.display = 'block';
            
            // SHOW SEARCH STATUS
            searchStatus.style.display = 'block';
            searchStatus.innerText = "CONNECTING TO SUB-ETHA...";
            
            playBeep(1200, 'sine', 0.2);
            userInput.textContent = ''; // CLEAR INPUT HERE

            let wikiText = null;
            let finalText = "";

            try {
                // Step 1: Fetch Wiki (includes Deep Search fallback)
                wikiText = await fetchWikipedia(query);
            } catch (e) {
                wikiText = "ERROR: Sub-Etha Net Unreachable.";
            }

            if (!wikiText) {
                // BETTER DIAGNOSTICS FOR NOT FOUND
                searchStatus.innerText = "PROBABILITY ZERO";
                finalText = `ENTRY NOT FOUND: "${query}"\n\nThe Guide searched the standard indices and performed a fuzzy search of the Sub-Etha Net, but found no probabilities.\n\nDiagnostics:\n- Exact Match: FAILED\n- Deep Search: 0 RESULTS\n\nSuggestion: Check spelling or try a broader term.`;
                
                // Allow user to see "PROBABILITY ZERO" briefly
                await new Promise(r => setTimeout(r, 1000));
            } else if (config.hybridMode) {
                // INTERMEDIATE STEP: Status update
                searchStatus.innerText = "DATA RETRIEVED";
                // Short pause so the user sees "Data Retrieved"
                await new Promise(r => setTimeout(r, 800));

                // Step 2: Use AI to Summarize
                // Update UI to show we are "Thinking"
                searchStatus.innerText = "PROCESSING...";
                
                // Allow the UI to update before blocking on fetch
                await new Promise(r => setTimeout(r, 100));

                const aiResult = await summarizeWithOllama(wikiText, query);
                
                if (aiResult.success) {
                    finalText = aiResult.text;
                } else {
                    // STRICT MODE: NO FALLBACK TO RAW WIKI
                    // Display error to help debugging
                    finalText = `ERROR: DEEP THOUGHT GENERATION FAILED.\n\nREASON: ${aiResult.error}\n\n(Ensure model '${config.ollamaModel}' is pulled and OLLAMA_ORIGINS="*" is set)`;
                }
            } else {
                // AI BYPASSED MODE
                searchStatus.innerText = "ACCESSING ARCHIVES...";
                await new Promise(r => setTimeout(r, 800));
                
                // Limit to first paragraph for brevity in bypass mode
                // Split by double newline to find paragraphs, take the first one
                const paragraphs = wikiText.split(/\n+/);
                finalText = paragraphs[0];
                
                // Safety trim if paragraph is massive
                if (finalText.length > 800) {
                    finalText = finalText.substring(0, 797) + "...";
                }
            }

            // UI State 3: Display
            searchGraphic.style.display = 'none';
            searchStatus.style.display = 'none'; // HIDE SEARCH STATUS
            mainDisplay.style.display = 'block';
            entryTitle.innerText = query.toUpperCase();
            typeText(finalText);
        }

        /* --- INPUT HANDLING --- */

        function handleKeyInput(char) {
            if (userInput.textContent.length < 25) {
                userInput.textContent += char;
                playKeyClick();
            }
        }

        function handleBackspace() {
            userInput.textContent = userInput.textContent.slice(0, -1);
            playBeep(200, 'square', 0.05);
        }

        function highlightKey(keyChar) {
            // Find button with matching data-key
            // Handle punctuation special cases
            let selector = `button[data-key="${keyChar.toUpperCase()}"]`;
            // Escape special chars for selector if needed, or simply don't highlight tricky ones
            try {
                const btn = document.querySelector(selector);
                if (btn) {
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 100);
                }
            } catch(e) {}
        }

        // On-screen keyboard clicks
        keyboard.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const key = e.target.dataset.key;
                
                // Only handle data-keys here (chars/space). Function keys have their own listeners.
                if (key) {
                    // INTERRUPT LOGIC: Tap to stop
                    if (isTyping) {
                        clearInterval(typingInterval);
                        isTyping = false;
                        
                        // If Space, stop output and don't type a space
                        if (key === 'SPACE') return;
                    }

                    if (key === 'SPACE') {
                        handleKeyInput(' ');
                    } else {
                        handleKeyInput(key);
                    }
                }
            }
        });

        // Specific function buttons
        backspaceBtn.addEventListener('click', handleBackspace);
        
        searchBtn.addEventListener('click', performSearch);
        
        clearBtn.addEventListener('click', () => {
            userInput.textContent = '';
            bootScreen.style.opacity = '1';
            mainDisplay.style.display = 'none';
            searchGraphic.style.display = 'none';
            guideText.innerHTML = '';
        });

        // AI Toggle Logic - Syncs both buttons
        function toggleAI() {
            config.hybridMode = !config.hybridMode;
            if (config.hybridMode) {
                // Set keyboard button state
                aiToggleBtn.classList.remove('bypassed');
                aiToggleBtn.classList.add('online');
                // Set top button state
                configBtn.innerText = "AI: ONLINE";
            } else {
                // Set keyboard button state
                aiToggleBtn.classList.remove('online');
                aiToggleBtn.classList.add('bypassed');
                // Set top button state
                configBtn.innerText = "AI: BYPASSED";
            }
        }

        // Attach synced listener to both buttons
        aiToggleBtn.addEventListener('click', toggleAI);
        configBtn.addEventListener('click', toggleAI);

        // Physical Keyboard Support
        window.addEventListener('keydown', (e) => {
            // STATE RESET: Ensure we can type even if isTyping got stuck
            // If typing is finished or user interrupts, stop animation
            if (isTyping) {
                clearInterval(typingInterval);
                isTyping = false;
                
                // IF SPACE IS PRESSED DURING TYPING: STOP, DON'T ADD SPACE
                if (e.key === ' ') {
                    e.preventDefault();
                    return; 
                }
                // Allow other keypresses to register immediately
            }

            if (e.key === 'Backspace') {
                handleBackspace();
                const btn = document.getElementById('backspaceBtn');
                btn.classList.add('active');
                setTimeout(() => btn.classList.remove('active'), 100);
            } else if (e.key === 'Enter') {
                performSearch();
                const btn = document.getElementById('searchBtn');
                btn.classList.add('active');
                setTimeout(() => btn.classList.remove('active'), 100);
            } else if (e.key === ' ') {
                handleKeyInput(' ');
                highlightKey('SPACE');
            } else if (e.key.length === 1 && /^[a-zA-Z0-9\-\.\'\_]$/.test(e.key)) {
                // UPDATED REGEX: Allows letters, numbers, hyphen, dot, apostrophe, underscore
                handleKeyInput(e.key.toUpperCase());
                highlightKey(e.key);
            }
        });

    </script>
</body>
</html>
